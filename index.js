const Discord = require('discord.js'), { Client, Intents } = require('discord.js'), client = new Client({ intents: [Intents.FLAGS.GUILDS, Intents.FLAGS.GUILD_MESSAGES] }), openai = require('openai'), dotenv = require('dotenv'); dotenv.config(); openai.apiKey = process.env.OPENAI_API_KEY; const messageHistory = new Map(); client.on('ready', () => { console.log(`Logged in as ${client.user.tag}!`); }); client.on('message', async msg => { if (msg.channel.name === process.env.CHAT_BOT_CHANNEL && !msg.author.bot) { try { let prompt = '', userId = msg.author.id, userMessages = messageHistory.get(userId) || [], thirtyMinutesAgo = Date.now() - (30 * 60 * 1000), recentMessages = userMessages.filter(msg => msg.timestamp >= thirtyMinutesAgo); recentMessages.forEach(msg => prompt += msg.content + ' '); userMessages.push({ content: msg.content, timestamp: Date.now() }); messageHistory.set(userId, userMessages); const response = await openai.completion.create({ engine: 'davinci', prompt: prompt, maxTokens: 150, temperature: 0.7 }); msg.channel.send(response.choices[0].text); } catch (err) { console.error(err); msg.channel.send('Oops, something went wrong!'); } } }); client.login(process.env.TOKEN);